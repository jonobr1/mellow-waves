<!doctype html>
<html lang="en">
  <head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no">

    <meta name="theme-color" content="#000">

    <title>Patatap: Mellow Waves</title>

    <meta name="name" content="Patatap">
    <meta name="image" content="http://cornelius.patatap.com/images/thumbnail.jpg">
    <meta name="description" content="Patatap is a portable animation and sound kit. With the touch of a finger create melodies charged with moving shapes. Warning: contains flashing images.">

    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="application-name" content="Patatap" />

    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Patatap">
    <meta name="twitter:description" content="Patatap is a portable animation and sound kit. With the touch of a finger create melodies charged with moving shapes. Warning: contains flashing images.">
    <meta name="twitter:creator" content="@jonobr1">

    <meta name="twitter:image:src" content="http://cornelius.patatap.com/images/thumbnail.jpg">

    <meta itemprop="name" content="Patatap">
    <meta itemprop="description" content="Patatap is a portable animation and sound kit. With the touch of a finger create melodies charged with moving shapes. Warning: contains flashing images.">
    <meta itemprop="image" src="http://cornelius.patatap.com/images/thumbnail.jpg">

    <meta property="og:title" content="Patatap">
    <meta property="og:type" content="website">
    <meta property="og:url" content="http://cornelius.patatap.com">
    <meta property="og:image" content="http://cornelius.patatap.com/images/thumbnail.jpg"/>
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">

    <meta property="og:site_name" content="Patatap">
    <meta property="og:description" content="Patatap is a portable animation and sound kit. With the touch of a finger create melodies charged with moving shapes. Warning: contains flashing images.">

    <link rel="icon" href="/images/favicon.ico" />

    <link rel="manifest" href="./manifest.json" />

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="apple-mobile-web-app-title" content="Patatap" />

    <style>

      * {
        margin: 0;
        padding: 0;
      }
      body {
        background: black;
        overflow: hidden;
        cursor: pointer;
        -webkit-tap-highlight-color: rgba(0,0,0,0);
        -webkit-tap-highlight-color: transparent;
      }
      #content {
        position: relative;
      }
      div.equalizer {
        position: absolute;
        top: 20px;
        right: 20px;
        border: 1px solid #ccc;
        background: white;
      }
      canvas {
        display: block;
        cursor: pointer;
      }
      #lobby {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 50px;
        height: 50px;
        margin-top: -25px;
        margin-left: -25px;
        opacity: 1;
        background: url(./images/icons/sync.svg) center center no-repeat;
        background-size: 100%;
        border-radius: 50%;
        z-index: 9999;
        -webkit-transition: opacity 0.35s cubic-bezier(0.075, 0.82, 0.165, 1);
        -moz-transition: opacity 0.35s cubic-bezier(0.075, 0.82, 0.165, 1);
        transition: opacity 0.35s cubic-bezier(0.075, 0.82, 0.165, 1);
        -webkit-transform-origin: center center;
        -moz-transform-origin: center center;
        -ms-transform-origin: center center;
        -o-transform-origin: center center;
        transform-origin: center center;
        -webkit-transform-style: preserve-3d;
        -moz-transform-style: preserve-3d;
        -ms-transform-style: preserve-3d;
        -o-transform-style: preserve-3d;
        transform-style: preserve-3d;
        -webkit-animation-name: spin;
        -moz-animation-name: spin;
        animation-name: spin;
        -webkit-animation-duration: 1s;
        -moz-animation-duration: 1s;
        animation-duration: 1s;
        -webkit-animation-iteration-count: infinite;
        -moz-animation-iteration-count: infinite;
        animation-iteration-count: infinite;
        -webkit-animation-timing-function: cubic-bezier(0.785, 0.135, 0.15, 0.86);
        -moz-animation-timing-function: cubic-bezier(0.785, 0.135, 0.15, 0.86);
        animation-timing-function: cubic-bezier(0.785, 0.135, 0.15, 0.86);
        content: ""; }
      body.loaded #lobby {
        opacity: 0;
      }
      @-webkit-keyframes spin {
        0% {
          -webkit-transform: scale(0.6) rotate(0deg); }
        100% {
          -webkit-transform: scale(0.6) rotate(360deg); } }
      @-moz-keyframes spin {
        0% {
          -moz-transform: scale(0.6) rotate(0deg); }
        100% {
          -moz-transform: scale(0.6) rotate(360deg); } }
      @keyframes spin {
        0% {
          -webkit-transform: scale(0.6) rotate(0deg);
          -moz-transform: scale(0.6) rotate(0deg);
          -ms-transform: scale(0.6) rotate(0deg);
          -o-transform: scale(0.6) rotate(0deg);
          transform: scale(0.6) rotate(0deg); }
        100% {
          -webkit-transform: scale(0.6) rotate(360deg);
          -moz-transform: scale(0.6) rotate(360deg);
          -ms-transform: scale(0.6) rotate(360deg);
          -o-transform: scale(0.6) rotate(360deg);
          transform: scale(0.6) rotate(360deg); } }
      .scripts {
        display: none;
      }

    </style>

    <link href="https://fonts.googleapis.com/css?family=Lora|Work+Sans:300" rel="stylesheet">

  </head>
  <body>
    <div id="content"></div>
    <div id="lobby"></div>
    <div class="scripts">
      <script src="./third-party/has.js"></script>
      <script src="./third-party/url.js"></script>
      <script src="./third-party/three-r90dev.js"></script>
      <script src="./third-party/two-v0.7.0.js"></script>
      <script src="./third-party/sound.js"></script>
      <script src="./third-party/equalizer.js"></script>
      <script src="./third-party/to-half.js"></script>
      <script src="./src/sequencer.js"></script>
      <script src="./src/gpgpu.js"></script>
      <script src="./src/simulation.js"></script>
      <script>

        if ('serviceWorker' in navigator) {
          navigator.serviceWorker.register('./service.js').then(function(serviceWorkerRegistration) {
            serviceWorkerRegistration.update();
          });
        }

        var root = /localhost/.test(window.location)
          ? './' : '//storage.googleapis.com/cdn.patatap.com/mellow-waves/';
        var TWO_PI = Math.PI * 2;
        var frameCount = 0;

        var urls = [
          'M01_1.mp3', 'M02_1.mp3', 'M03_1.mp3', 'M04_1.mp3', 'M05_1.mp3',
          'M06_1.mp3', 'M07_1.mp3', 'M08_1.mp3', 'M09_1.mp3', 'M10_1.mp3',
          'M11_1.mp3', 'M12_1.mp3', 'M13_1.mp3', 'M14_1.mp3', 'M15_1.mp3',
          'M16_1.mp3', 'M17_1.mp3', 'M18_1.mp3', 'M19_1.mp3', 'M20_1.mp3',
          'M21_1.mp3', 'M22_1.mp3', 'M23_1.mp3', 'M24_1.mp3', 'M25_1.mp3',
          'M26_1.mp3'//, 'M27_1.mp3', 'M28_1.mp3', 'M29_1.mp3', 'M30_1.mp3'
        ];

        var freqs = {
          a: 1, b: 8, c: 0.5, d: 8, e: 8, f: 10, g: 1, h: 4, i: 2, j: 1.5, k: 2,
          l: 3, m: 8, n: 8, o: 2, p: 5, q: 5, r: 2, s: 6, t: 1.5, u: 10,
          v: 10, w: 10, x: 4, y: 8, z: 4
        };

        var keys = {
          a: 0, b: 1, c: 2, d: 3, e: 4, f: 5, g: 6, h: 7, i: 8, j: 9, k: 10,
          l: 11, m: 12, n: 13, o: 14, p: 15, q: 16, r: 17, s: 18, t: 19, u: 20,
          v: 21, w: 22, x: 23, y: 24, z: 25
        };

        var sounds = [];
        sounds.index = 0;
        sounds.ready = false;

        var equalizer, resolution = 11;
        var size = 512;

        var two = new Two({
          type: Two.Types.canvas,
          fullscreen: true
        });

        var sequencer = new Sequencer(Sound.ctx);
        var loader = new THREE.TextureLoader();

        var ring = two.makePolygon(0, 0, Math.min(two.width, two.height) / 4.6, 512);
        ring.stroke = 'white';
        ring.noFill();
        ring.visible = false;
        ring.phi = 2;
        ring.join = 'round';
        ring.direction = 1;
        ring.magnitude = 0.3;
        ring.velocity = 0;
        ring.radius = Math.min(two.width, two.height) / 4.6;

        var logo = two.makeSprite(root + 'images/cornelius-logo.png', 0, 0);
        logo.visible = false;
        logo.opacity = 0;
        logo.texture.bind(Two.Events.load, function() {
          logo.visible = !url.boolean('kiosk');
        });

        var textStyles = {
          stroke: 'none',
          fill: '#fff',
          size: '13px',
          family: '"Work Sans", "Lora", sans-serif',
          weight: 300,
          opacity: 0.66
        };
        var buy = {
          physical: two.makeText('P h y s i c a l      A l b u m'.toUpperCase(), 0, 0, textStyles),
          digital: two.makeText('D i g i t a l      A l b u m'.toUpperCase(), 0, 0, textStyles)
        };

        var shouldBuy = false;

        buy.physical.link = 'https://cornelius.storenvy.com';
        buy.digital.link = 'https://fanlink.to/CorneliusMellowWaves';

        buy.physical.onClick = function() {
          if (url.boolean('kiosk')) {
            return;
          }
          gtag('event', 'referral', {
            'event_category': 'merchandise',
            'event_label': 'physical',
            'value': 1
          });
          window.location.href = buy.physical.link;
        };
        buy.digital.onClick = function() {
          if (url.boolean('kiosk')) {
            return;
          }
          gtag('event', 'referral', {
            'event_category': 'merchandise',
            'event_label': 'digital',
            'value': 1
          });
          window.location.href = buy.digital.link;
        };

        if (url.boolean('kiosk')) {
          buy.physical.visible = false;
          buy.digital.visible = false;
        }

        var renderer = new THREE.WebGLRenderer({ antialias: true, stencil: false });
        var scene = new THREE.Scene();
        var camera = new THREE.PerspectiveCamera(60);
        camera.frustumSize = 100;
        camera.position.z = camera.frustumSize;
        if (has.mobile) {
          renderer.setPixelRatio(1);
        }

        geometry = new THREE.PlaneBufferGeometry(
          camera.frustumSize / 2, camera.frustumSize / 2);

        material = new THREE.MeshBasicMaterial({
          map: loader.load(root + 'images/glow.jpg'),
          opacity: 0,
          transparent: true,
          depthWrite: false,
          depthTest: false,
          blending: THREE.AdditiveBlending
        });

        var glows = new THREE.Group();
        glows.userData.amount = 12;
        scene.add(glows);

        for (var i = 0; i < glows.userData.amount; i++) {

          var pct = i / (glows.userData.amount - 1);
          var theta = TWO_PI * pct;
          var glow = new THREE.Mesh(geometry, material.clone());

          glow.position.x = camera.frustumSize * Math.cos(theta) / 3.75;
          glow.position.y = camera.frustumSize * Math.sin(theta) / 3.75;
          glow.userData.band = Math.floor(Math.random() * Equalizer.Resolution / 2);
          glow.userData.opacity = Math.random();
          glow.userData.scale = Math.random();

          glows.add(glow);

        }

        var gpgpu = new GPGPU(renderer);
        var simulation = new GPGPU.Simulation()
          .setRadius( camera.frustumSize / 4 );

        var origins = {
          data: new Float32Array(size * size * 3),
          // data: new Uint16Array(size * size * 4),
          // data: new Uint8Array(size * size * 4),
          resolution: simulation.material.uniforms.resolution.value
        };

        for (var i = 0, l = origins.data.length; i < l; i += 3) {

          // origins.data[i + 0] = toHalf(origins.resolution * Math.random());
          // origins.data[i + 1] = toHalf(origins.resolution * Math.random());
          // origins.data[i + 2] = toHalf(origins.resolution * Math.random());
          // origins.data[i + 3] = toHalf(0);

          origins.data[i + 0] = origins.resolution * Math.random();
          origins.data[i + 1] = origins.resolution * Math.random();
          origins.data[i + 2] = origins.resolution * Math.random();
          // origins.data[i + 3] = 0;

        }

        origins.texture = new THREE.DataTexture(origins.data, size, size, THREE.RGBFormat, THREE.FloatType);
        origins.texture.minFilter = THREE.NearestFilter;
        origins.texture.magFilter = THREE.NearestFilter;
        origins.texture.needsUpdate = true;

        simulation.setOriginsTexture(origins.texture);

        // var renderTargetType = ( /(iPad|iPhone|iPod)/g.test( navigator.userAgent ) )
        //   ? THREE.HalfFloatType : THREE.FloatType;
        var renderTargetType = THREE.HalfFloatType;

        var renderTargets = {
          a: new THREE.WebGLRenderTarget(size, size, {
            minFilter: THREE.NearestFilter,
            magFilter: THREE.NearestFilter,
            format: THREE.RGBAFormat,
            type: renderTargetType,
            depthBuffer: false,
            stencilBuffer: false
          }),
          b: new THREE.WebGLRenderTarget(size, size, {
            minFilter: THREE.NearestFilter,
            magFilter: THREE.NearestFilter,
            format: THREE.RGBAFormat,
            type: renderTargetType,
            depthBuffer: false,
            stencilBuffer: false
          })
        };

        var positions = new Float32Array(size * size * 3);

        for (var i = 0, j = 0, l = positions.length / 3; i < l; i ++, j += 3) {
          positions[j + 0] = (i % size) / size;
          positions[j + 1] = Math.floor(i / size) / size;
        }

        geometry = new THREE.BufferGeometry();
        geometry.addAttribute('position', new THREE.BufferAttribute(positions, 3));

        material = new THREE.ShaderMaterial({
          uniforms: {
            uvTransform: {
              type: 'm3',
              value: new THREE.Matrix3().set(0, 0, 1, 1, 0, 0, 0)
            },
            fft: {
              type: 'f',
              value: 0
            },
            rotation: {
              type: 'f',
              value: 0
            },
            map: {
              type: 't',
              value: renderTargets.a.texture
            },
            radius: {
              type: 'f',
              value: camera.frustumSize / 4
            }
          },
          vertexShader: [

            'const float PI = ' + Math.PI + ';',

            'uniform sampler2D map;',
            'uniform float fft;',
            'uniform float rotation;',
            'uniform float radius;',

            'varying float opacity;',

            'void main() {',

              'vec4 data = texture2D( map, position.xy );',
              'vec3 vPosition = vec3( data.xyz );',

              'gl_PointSize = 1.0;',
              'opacity = step( 0.16, data.w );',

              'gl_Position = projectionMatrix * modelViewMatrix * vec4( vPosition, 1.0 );',

            '}'

          ].join('\n'),
          fragmentShader: [

            'varying float opacity;',

            'void main() {',
              'gl_FragColor = vec4( 1.0, 1.0, 1.0, opacity );',
            '}'

          ].join('\n'),
          blending: THREE.AdditiveBlending,
          depthWrite: false,
          transparent: true
        });
        var points = new THREE.Points(geometry, material);
        scene.add(points);

        var buttons = [
          new Array(10),
          new Array(9),
          new Array(7)
        ];
        buttons.list = [];

        for (var i = 0; i < urls.length; i++) {

          var uri = root + 'assets/sounds/' + urls[i];
          var seed = Math.random();

          sounds.push(new Sound(uri, loaded));

          sounds[i].phi = Math.floor(seed * 30) + 2;
          sounds[i].direction = Math.random() > 0.5 ? 1 : - 1;
          sounds[i].magnitude = Math.sin(seed * Math.PI + Math.PI / 2) * 0.5 + 0.1;
          sounds[i].velocity = Math.random() * Math.PI / 16 + Math.PI / 16;
          sounds[i].key = getKey(i);
          sounds[i].frequency = freqs[sounds[i].key];

        }

        for (var i = 0, id = 0; i < buttons.length; i++) {
          var row = buttons[i];
          for (var j = 0; j < row.length; j++) {
            buttons[i][j] = createButton(i, j, id);
            id++;
          }
        }

        function loaded() {
          sounds.index++;
          if (sounds.index >= sounds.length && !sounds.ready) {
            document.body.classList.add('loaded');
            sounds.ready = true;
            sounds[0].gain.gain.value = 1.5;
            setup();
          }
        }

        function setup() {

          renderer.setClearColor(0x000000);

          var container = document.querySelector('#content');

          if (isWebGLCompatible()) {
            container.appendChild(renderer.domElement);
          }
          two.appendTo(container);

          equalizer = new Equalizer();//.appendTo(document.body);

          if (has.mobile) {
            setupTouchEvents();
          } else {
            setupMouseEvents();
          }

          window.addEventListener('keydown', function(e) {
            var key = String.fromCharCode(e.which).toLowerCase();
            var sound = sounds[keys[key]];
            if (!sound) {
              return;
            }
            sound.button.opacity = 1;
            trigger(sound);
          }, false);

          window.addEventListener('keyup', function(e) {
            var key = String.fromCharCode(e.which).toLowerCase();
            var sound = sounds[keys[key]];
            if (!sound) {
              return;
            }
            sequencer.remove(sound);
          });

          window.addEventListener('resize', resize, false);
          resize();

          window.addEventListener('visibilitychange', function(e) {
            switch (document.visibilityState) {
              case 'visible':
                Sound.volume.gain.value = 1;
                break;
              case 'hidden':
                Sound.volume.gain.value = 0;
                break;
            }
          }, false);

          loop();
          sequencer.start();

        }

        function loop(millis) {

          update();

          if (isWebGLCompatible()) {

            simulation.setTimer((millis || 0) / 1000);

            if (frameCount % 2 === 0) {
              gpgpu.pass(simulation.setPositionsTexture(renderTargets.a), renderTargets.b);
              material.uniforms.map.value = renderTargets.b.texture;
            } else {
              gpgpu.pass(simulation.setPositionsTexture(renderTargets.b), renderTargets.a);
              material.uniforms.map.value = renderTargets.a.texture;
            }
            frameCount++;

            renderer.render(scene, camera);

          }

          two.update();

          requestAnimationFrame(loop);

        }

        function update() {

          equalizer.update(true);

          var length = Math.max(buttons.list.length, ring.vertices.length);
          var radius = ring.radius;
          var phi = ring.phi;
          var fft = equalizer.average.value / 256;
          var magnitude = ring.magnitude;
          var rStep = ring.velocity * ring.direction;

          fft = Math.pow(fft, 10);

          ring.rotation += rStep / (50 * Math.sqrt( phi / 30 ));
          // glows.rotation.z = ring.rotation;

          simulation
            .setFFT(fft)
            .setRotation(ring.rotation);

          material.uniforms.fft.value = fft;
          material.uniforms.rotation.value -= (fft * Math.PI / 20) * ring.direction;

          if (logo.visible) {
            if (logo.opacity < 0.9999) {
              logo.opacity += (1 - logo.opacity) * 0.0625;
            } else if (logo.opacity < 1) {
              logo.opacity = 1;
            }
          }

          for (var i = 0; i < length; i++) {

            if (ring.visible) {

              var pct = i / (ring.vertices.length - 1);
              var anchor = ring.vertices[i];

              if (anchor) {

                setPosition(pct, anchor, radius, magnitude, fft, phi);

              }

            }

            var glow = glows.children[i];

            if (glow) {

              var band = equalizer.bands[glow.userData.band].peak.value;
              band /= 256;
              band = Math.pow(band, 10);

              opacity = (band + 0.1) * glow.userData.opacity;

              // setPosition(
              //   i / (glows.userData.amount - 1),
              //   glow.position,
              //   camera.frustumSize / 4,
              //   magnitude,
              //   fft,
              //   phi
              // );

              glow.scale.x += ((band * glow.userData.scale + 1) - glow.scale.x) * 0.0125;
              glow.scale.y = glow.scale.x;
              glow.material.opacity += (opacity - glow.material.opacity) * 0.125;

            }

            var button = buttons.list[i];
            if (!button) {
              continue;
            }

            if (button.pressed) {
              opacity = 1;
            } else if (button.opacity > 0.001) {
              button.opacity -= button.opacity * 0.125;
            } else {
              button.opacity = 0;
            }

            if (button.fillOpacity > 0.001) {
              button.fillOpacity -= button.fillOpacity * 0.0625;
              button.fill = 'rgba(255, 255, 255, ' + button.fillOpacity + ')';
            } else if (button.fillOpacity > 0) {
              button.fillOpacity = 0;
              button.fill = 'rgba(255, 255, 255, ' + button.fillOpacity + ')';
            }

          }

        }

        function resize() {

          var aspect = two.width / two.height;
          var frustumSize = camera.frustumSize;

          var margin = getMargin();
          var width = two.width - margin * 8;
          var height = two.height - margin * 2;

          renderer.setSize(two.width, two.height);

          camera.aspect = aspect;
          camera.updateProjectionMatrix();

          ring.radius = Math.min(two.width, two.height) / 4.6;
          ring.width = ring.height = ring.radius;
          ring.linewidth = ring.radius / 50;
          ring.visible = !isWebGLCompatible();

          buy.physical.translation.x = - (width + margin * 4) / 2;
          buy.physical.rotation = - Math.PI / 2;
          buy.digital.translation.x = (width + margin * 4) / 2;
          buy.digital.rotation = Math.PI / 2;

          var logoAspect = 108 / 780;
          logo.scale = 0.75 * two.height / 780;

          two.scene.translation.set(two.width / 2, two.height / 2);

          for (var i = 0; i < buttons.length; i++) {

            var xpct = 1 / buttons[i].length;
            var ypct = 1 / buttons.length;

            for (var j = 0; j < buttons[i].length; j++) {

              var button = buttons[i][j];
              var x = (j + 0.5) / buttons[i].length;
              var y = (i + 0.5) / buttons.length;

              x -= 0.5;
              x *= width;

              y -= 0.5;
              y *= height;

              button.translation.set(x, y);
              button.width = xpct * width - margin / 2;
              button.height = ypct * height - margin / 2;

            }
          }

        }

        function trigger(sound, callback) {

          sequencer.add(sound, sound.frequency, callback);

          ring.phi = sound.phi;
          ring.direction = sound.direction;
          ring.magnitude = sound.magnitude;
          ring.velocity = sound.velocity;

          simulation.setPhi(ring.phi);
          simulation.setMagnitude(ring.magnitude);

        }

        function createButton(col, row, id) {

          var toKey = [
            'q', 'w', 'e', 'r', 't', 'y', 'u', 'i', 'o', 'p', 'a', 's', 'd',
            'f', 'g', 'h', 'j', 'k', 'l', 'z', 'x', 'c', 'v', 'b', 'n', 'm'
          ];
          var sound = sounds[keys[toKey[id]]];
          var button = two.makeRoundedRectangle(0, 0, 0, 0, 12);

          button.linewidth = 1;
          button.stroke = 'white';
          button.noFill();
          button.opacity = 0;
          button.sound = sound;
          sound.button = button;
          buttons.list.push(button);

          return button;

        }

        function setupTouchEvents() {

          var cursors = {};

          var triggerButton = function(cursor, button) {

            shouldBuy = false;
            cursor.button.pressed = true;
            button.opacity = 1;
            button.fillOpacity = 1;

            trigger(button.sound, function() {
              button.fillOpacity = 1;
            });
          };
          var touchstart = function(e) {

            var margin = getMargin();
            var width = two.width - margin * 8;
            var height = two.height - margin * 2;

            shouldBuy = true;

            var touches = e.touches;
            for (var i = 0; i < touches.length; i++) {

              var touch = touches[i];
              if (!(touch.identifier in cursors)) {
                cursors[touch.identifier] = new Two.Vector(
                  (touch.clientX - margin * 4) / width,
                  (touch.clientY - margin) / height
                );
              } else {
                cursors[touch.identifier].set(
                  (touch.clientX - margin * 4) / width,
                  (touch.clientY - margin) / height
                );
              }

              var cursor = cursors[touch.identifier];
              var row = Math.floor(buttons.length * cursor.y);

              if (row >= 0 && row < buttons.length) {
                var col = Math.floor(buttons[row].length * cursor.x);
                if (col >= 0 && col < buttons[row].length) {
                  var button = buttons[row][col];
                  cursor.button = button;
                  triggerButton(cursor, button);
                }
              }

            }

          };
          var touchmove = function(e) {

            var margin = getMargin();
            var width = two.width - margin * 8;
            var height = two.height - margin * 2;

            var touches = e.touches;
            for (var i = 0; i < touches.length; i++) {

              var touch = touches[i];
              if (!(touch.identifier in cursors)) {
                cursors[touch.identifier] = new Two.Vector(
                  (touch.clientX - margin * 4) / width,
                  (touch.clientY - margin) / height
                );
              } else {
                cursors[touch.identifier].set(
                  (touch.clientX - margin * 4) / width,
                  (touch.clientY - margin) / height
                );
              }

              var cursor = cursors[touch.identifier];
              var row = Math.floor(buttons.length * cursor.y);
              if (row >= 0 && row < buttons.length) {
                var col = Math.floor(buttons[row].length * cursor.x);
                if (col >= 0 && col < buttons[row].length) {
                  var button = buttons[row][col];
                  if (button !== cursor.button) {
                    if (cursor.button) {
                      release(cursor);
                    }
                    cursor.button = button;
                    triggerButton(cursor, button);
                  }
                } else if (cursor.button) {
                  release(cursor);
                }
              } else if (cursor.button) {
                release(cursor);
              }

            }

          };
          var touchend = function(e) {

            var margin = getMargin();
            var width = two.width - margin * 8;
            var height = two.height - margin * 2;

            for (var id in cursors) {

              var cursor = cursors[id];

              if (cursor.button) {
                release(cursor);
              }

              if (shouldBuy) {

                for (var type in buy) {

                  var button = buy[type];

                  var x = cursor.x * width + margin * 4;
                  var y = cursor.y * height + margin;

                  var bx = button.translation.x + two.scene.translation.x;
                  var by = button.translation.y + two.scene.translation.y;

                  var dx = Math.abs(bx - x);
                  var dy = Math.abs(by - y);

                  if (dx < 2 * margin && dy < 10 * margin) {
                    button.onClick();
                    break;
                  }
                }

              }

            }
          };
          var release = function(cursor) {
            sequencer.remove(cursor.button.sound);
            cursor.button.pressed = false;
            delete cursor.button;
          };

          window.addEventListener('touchstart', touchstart, false);
          window.addEventListener('touchmove', touchmove, false);
          window.addEventListener('touchend', touchend, false);
          window.addEventListener('touchcancel', touchend, false);

          two.renderer.domElement.addEventListener('click', resume, false);

        }

        function resume(e) {

          var ctx = Sound.ctx;

          if (ctx && /suspended/i.test(ctx.state)) {
            ctx.resume();
          }

          two.renderer.domElement.removeEventListener('click', resume, false);

        }

        function setupMouseEvents() {

          window.addEventListener('click', function(e) {

            e.preventDefault();

            var margin = getMargin();
            var width = two.width - margin * 8;
            var height = two.height - margin * 2;
            var x = e.clientX;
            var y = e.clientY;

            if (!shouldBuy) {
              return false;
            }

            for (var type in buy) {

              var button = buy[type];

              var bx = button.translation.x + two.scene.translation.x;
              var by = button.translation.y + two.scene.translation.y;

              var dx = Math.abs(bx - x);
              var dy = Math.abs(by - y);

              if (dx < 2 * margin && dy < 10 * margin) {
                button.onClick();
                break;
              }
            }

            return false;

          });

          var mouse = new Two.Vector();

          var triggerButton = function(button) {

            shouldBuy = false;
            mouse.button.pressed = true;

            button.opacity = 1;
            button.fillOpacity = 1;

            trigger(button.sound, function() {
              button.fillOpacity = 1;
            });

          };
          var mousedown = function(e) {

            var margin = getMargin();
            var width = two.width - margin * 8;
            var height = two.height - margin * 2;

            shouldBuy = true;
            mouse.set(
              (e.clientX - margin * 4) / width,
              (e.clientY - margin) / height
            );

            window.addEventListener('mousemove', mousemove, false);
            window.addEventListener('mouseup', mouseup, false);

            var row = Math.floor(buttons.length * mouse.y);
            if (row >= 0 && row < buttons.length) {
              var col = Math.floor(buttons[row].length * mouse.x);
              if (col >= 0 && col < buttons[row].length) {
                var button = buttons[row][col];
                mouse.button = button;
                triggerButton(button);
              }
            }

          };
          var mousemove = function(e) {

            var margin = getMargin();
            var width = two.width - margin * 8;
            var height = two.height - margin * 2;

            mouse.set(
              (e.clientX - margin * 4) / width,
              (e.clientY - margin) / height
            );

            var row = Math.floor(buttons.length * mouse.y);
            if (row >= 0 && row < buttons.length) {
              var col = Math.floor(buttons[row].length * mouse.x);
              if (col >= 0 && col < buttons[row].length) {
                var button = buttons[row][col];
                if (button !== mouse.button) {
                  if (mouse.button) {
                    release();
                  }
                  mouse.button = button;
                  triggerButton(button);
                }
              } else if (mouse.button) {
                release();
              }
            } else if (mouse.button) {
              release();
            }

          };
          var mouseup = function(e) {
            if (mouse.button) {
              release();
            }
            window.removeEventListener('mousemove', mousemove, false);
            window.removeEventListener('mouseup', mouseup, false);
          };
          var release = function() {
            sequencer.remove(mouse.button.sound);
            mouse.button.pressed = false;
            delete mouse.button;
          };

          if (!has.mobile) {
            window.addEventListener('mousedown', mousedown, false);
          }

        }

        function getKey(i) {
          for (var k in keys) {
            var key = keys[k];
            if (i === key) {
              return k;
            }
          }
          return null;
        }

        function isWebGLCompatible() {
          return renderer.context.getExtension('OES_texture_float')
            && renderer.capabilities.maxVertexTextures > 0;
        }

        function getMargin() {
          return Math.max(two.width * 0.01, 10);
        }

        function setPosition(pct, anchor, radius, magnitude, fft, phi) {

          var theta = pct * TWO_PI;
          var phase = Math.sin(pct * TWO_PI * phi);
          var amp = radius * (1 + phase * magnitude * fft);

          var x = amp * Math.cos(theta);
          var y = amp * Math.sin(theta);

          anchor.x = x;
          anchor.y = y;

        }

      </script>

      <!-- Global site tag (gtag.js) - Google Analytics -->
      <script async src="https://www.googletagmanager.com/gtag/js?id=UA-115002525-1"></script>
      <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-115002525-1');
      </script>

    </div>
    <noscript>JavaScript is required to view this page!</noscript>
  </body>
</html>
